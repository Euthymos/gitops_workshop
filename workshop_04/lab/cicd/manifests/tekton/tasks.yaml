apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone-http
  namespace: cicd
spec:
  params:
    - name: repoFullName
      type: string
      description: "napr. admin/app-repo"
    - name: revision
      type: string
      default: main
    - name: giteaBaseUrl
      type: string
      default: "http://gitea-http.gitea.svc.cluster.local:3000"
  workspaces:
    - name: source
  steps:
    - name: clone
      image: alpine/git:2.45.2
      env:
        - name: GITEA_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: username
        - name: GITEA_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: token
      script: |
        #!/bin/sh
        set -e
        apk add --no-cache ca-certificates
        cd $(workspaces.source.path)
        rm -rf src
        # HTTP token auth in URL (workshop-friendly)
        URL="$(params.giteaBaseUrl)/$(params.repoFullName).git"
        AUTH_URL=$(echo "$URL" | sed "s#http://#http://${GITEA_USERNAME}:${GITEA_TOKEN}@#")
        git clone "$AUTH_URL" src
        cd src
        git checkout "$(params.revision)"
        echo "Checked out: $(git rev-parse HEAD)"

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: npm-run
  namespace: cicd
spec:
  params:
    - name: script
      type: string
    - name: image
      type: string
      default: node:20-alpine
  workspaces:
    - name: source
  steps:
    - name: script
      image: $(params.image)
      workingDir: $(workspaces.source.path)/src
      script: |
        npm $(params.script)

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build-push-incluster-registry
  namespace: cicd
spec:
  params:
    - name: image
      type: string
      description: "napr. registry.kube-system.svc.cluster.loca/todos-spa:tag"
    - name: dockerfile
      type: string
      default: Dockerfile
    - name: context
      type: string
      default: .
  workspaces:
    - name: source
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.23.2
      workingDir: $(workspaces.source.path)/src
      args:
        - --dockerfile=$(params.dockerfile)
        - --context=$(workspaces.source.path)/src/$(params.context)
        - --destination=$(params.image)
        # HTTP registry
        - --insecure
        - --skip-tls-verify
        - --insecure-pull
        - --skip-tls-verify-pull

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-helm-image-tag
  namespace: cicd
spec:
  params:
    - name: helmRepoFullName
      type: string
      default: "admin/helm-repo"
    - name: giteaBaseUrl
      type: string
      default: "http://gitea-http.gitea.svc.cluster.local:3000"
    - name: valuesFilePath
      type: string
      default: "todos-spa/values-dev.yaml"
    - name: newTag
      type: string
  workspaces:
    - name: source
  steps:
    - name: update
      image: alpine:3.20
      env:
        - name: GITEA_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: username
        - name: GITEA_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: token
      script: |
        #!/bin/sh
        set -e

        apk add --no-cache git yq

        cd $(workspaces.source.path)
        rm -rf helmrepo

        URL="$(params.giteaBaseUrl)/$(params.helmRepoFullName).git"
        AUTH_URL=$(echo "$URL" | sed "s#http://#http://${GITEA_USERNAME}:${GITEA_TOKEN}@#")
        git clone "$AUTH_URL" helmrepo
        cd helmrepo

        echo "Updating $(params.valuesFilePath) -> image.tag=$(params.newTag)"
        yq -i '.image.tag = "'"$(params.newTag)"'"' "$(params.valuesFilePath)"

        git config user.email "pipeline-bot@gitea.local"
        git config user.name "pipeline-bot"
        git add "$(params.valuesFilePath)"
        git commit -m "Update image tag to $(params.newTag)" || echo "No changes to commit"
        git push
