apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-clone-http
  namespace: cicd
spec:
  params:
    - name: repoFullName
      type: string
      description: "napr. admin/app-repo"
    - name: revision
      type: string
      default: main
    - name: giteaBaseUrl
      type: string
      default: "http://gitea-http.gitea.svc.cluster.local:3000"
  workspaces:
    - name: source
  steps:
    - name: clone
      image: alpine/git:2.45.2
      env:
        - name: GITEA_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: username
        - name: GITEA_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: token
      script: |
        #!/bin/sh
        set -e
        apk add --no-cache ca-certificates
        cd $(workspaces.source.path)
        rm -rf src
        # HTTP token auth in URL (workshop-friendly)
        URL="$(params.giteaBaseUrl)/$(params.repoFullName).git"
        AUTH_URL=$(echo "$URL" | sed "s#http://#http://${GITEA_USERNAME}:${GITEA_TOKEN}@#")
        git clone "$AUTH_URL" src
        cd src
        git checkout "$(params.revision)"
        echo "Checked out: $(git rev-parse HEAD)"

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: npm-run
  namespace: cicd
spec:
  params:
    - name: script
      type: string
    - name: image
      type: string
      default: registry.access.redhat.com/ubi10/nodejs-20-minimal:latest
  workspaces:
    - name: source
  steps:
    - name: run
      image: $(params.image)
      workingDir: $(workspaces.source.path)/src
      script: |
        npm run "$(params.script)"

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build-push-incluster-registry
  namespace: cicd
spec:
  params:
    - name: image
      type: string
      description: "napr. registry.kube-system.svc.cluster.local:5000/myapp:tag"
    - name: dockerfile
      type: string
      default: Dockerfile
    - name: context
      type: string
      default: .
  workspaces:
    - name: source
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.23.2
      workingDir: $(workspaces.source.path)/src
      args:
        - --dockerfile=$(params.dockerfile)
        - --context=$(workspaces.source.path)/src/$(params.context)
        - --destination=$(params.image)
        # HTTP registry
        - --insecure
        - --skip-tls-verify
        - --insecure-pull
        - --skip-tls-verify-pull

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-helm-image-tag
  namespace: cicd
spec:
  params:
    - name: helmRepoFullName
      type: string
      default: "admin/helm-repo"
    - name: giteaBaseUrl
      type: string
      default: "http://gitea-http.gitea.svc.cluster.local:3000"
    - name: valuesFilePath
      type: string
      default: "todos-spa/values-dev.yaml"
    - name: newTag
      type: string
  workspaces:
    - name: source
  steps:
    - name: update
      image: alpine:3.20
      env:
        - name: GITEA_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: username
        - name: GITEA_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-credentials
              key: token
      script: |
        #!/bin/sh
        set -e
        apk add --no-cache git yq

        cd $(workspaces.source.path)
        rm -rf helmrepo

        URL="$(params.giteaBaseUrl)/$(params.helmRepoFullName).git"
        AUTH_URL=$(echo "$URL" | sed "s#http://#http://${GITEA_USERNAME}:${GITEA_TOKEN}@#")
        git clone "$AUTH_URL" helmrepo
        cd helmrepo

        echo "Updating $(params.valuesFilePath) -> image.tag=$(params.newTag)"
        yq -i '.image.tag = "'"$(params.newTag)"'"' "$(params.valuesFilePath)"

        git config user.email "pipeline-bot@gitea.local"
        git config user.name "pipeline-bot"
        git add "$(params.valuesFilePath)"
        git commit -m "Update image tag to $(params.newTag)" || echo "No changes to commit"
        git push

---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: app-ci-to-helm-update
  namespace: cicd
spec:
  params:
    - name: appRepoFullName
      type: string
      description: "napr. admin/app-repo"
    - name: appRevision
      type: string
      default: main
    - name: imageRepo
      type: string
      default: "registry.kube-system.svc.cluster.local:5000/todos-spa"
    - name: imageTag
      type: string
      description: "napr. git SHA"
    - name: helmRepoFullName
      type: string
      default: "admin/helm-repo"
    - name: helmValuesPath
      type: string
      default: "myapp/values-dev.yaml"
  workspaces:
    - name: shared
  tasks:
    - name: clone
      taskRef:
        name: git-clone-http
      params:
        - name: repoFullName
          value: $(params.appRepoFullName)
        - name: revision
          value: $(params.appRevision)
      workspaces:
        - name: source
          workspace: shared

    - name: npm-install
      runAfter:
        - clone
      taskRef:
        name: npm-run
      params:
        - name: script
          value: install
      workspaces:
        - name: source
          workspace: shared

    - name: test
      runAfter:
        - npm-install
      taskRef:
        name: npm-run
      params:
        - name: script
          value: test
      workspaces:
        - name: source
          workspace: shared

    - name: lint
      runAfter:
        - npm-install
      taskRef:
        name: npm-run
      params:
        - name: script
          value: lint
      workspaces:
        - name: source
          workspace: shared

    - name: build-push
      runAfter:
        - test
        - lint
      taskRef:
        name: kaniko-build-push-incluster-registry
      params:
        - name: image
          value: $(params.imageRepo):$(params.imageTag)
      workspaces:
        - name: source
          workspace: shared

    - name: update-helm
      runAfter: ["build-push"]
      taskRef:
        name: update-helm-image-tag
      params:
        - name: helmRepoFullName
          value: $(params.helmRepoFullName)
        - name: valuesFilePath
          value: $(params.helmValuesPath)
        - name: newTag
          value: $(params.imageTag)
      workspaces:
        - name: source
          workspace: shared
